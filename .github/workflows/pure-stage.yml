name: Pure Stage CI

# è§¦å‘æ¡ä»¶ï¼šPR æ¶‰åŠå‰ç«¯ä»£ç æˆ–å›¾ç‰‡èµ„æº
on:
  pull_request:
    paths:
      - 'frontend/src/**'
      - 'frontend/assets/**'
      - 'frontend/package.json'
      - 'frontend/tsconfig.json'
  push:
    branches:
      - main
      - develop
    paths:
      - 'frontend/src/**'
      - 'frontend/assets/**'

# ç¯å¢ƒå˜é‡
env:
  NODE_VERSION: '22'

jobs:
  # ============================================
  # Job 1: ä»£ç è´¨é‡æ£€æŸ¥
  # ============================================
  code-quality:
    name: ä»£ç è´¨é‡æ£€æŸ¥
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./frontend

    steps:
      # 1. æ£€å‡ºä»£ç 
      - name: ğŸ“¥ Checkoutä»£ç 
        uses: actions/checkout@v4

      # 2. è®¾ç½® Node.js ç¯å¢ƒ
      - name: âš™ï¸ è®¾ç½® Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: './frontend/package-lock.json'

      # 3. å®‰è£…ä¾èµ–
      - name: ğŸ“¦ å®‰è£…ä¾èµ–
        run: npm ci

      # 4. TypeScript ç±»å‹æ£€æŸ¥
      - name: ğŸ” TypeScript ç±»å‹æ£€æŸ¥
        run: npm run type-check

      # 5. é—ç•™ä»£ç æ‰«æ
      - name: ğŸš« é—ç•™ä»£ç æ‰«æ
        run: npm run scan:legacy

  # ============================================
  # Job 2: æ„å»ºæµ‹è¯•
  # ============================================
  build:
    name: æ„å»ºæµ‹è¯•
    runs-on: ubuntu-latest
    needs: code-quality
    defaults:
      run:
        working-directory: ./frontend

    steps:
      # 1. æ£€å‡ºä»£ç 
      - name: ğŸ“¥ Checkout ä»£ç 
        uses: actions/checkout@v4

      # 2. è®¾ç½® Node.js ç¯å¢ƒ
      - name: âš™ï¸ è®¾ç½® Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: './frontend/package-lock.json'

      # 3. å®‰è£…ä¾èµ–
      - name: ğŸ“¦ å®‰è£…ä¾èµ–
        run: npm ci

      # 4. ç”Ÿäº§æ„å»º
      - name: ğŸ”¨ æ„å»ºç”Ÿäº§ç‰ˆæœ¬
        run: npm run build

      # 5. ä¸Šä¼ æ„å»ºäº§ç‰©ï¼ˆä¾›åç»­æµ‹è¯•ä½¿ç”¨ï¼‰
      - name: ğŸ“¤ ä¸Šä¼ æ„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: dist
          path: frontend/dist
          retention-days: 1

  # ============================================
  # Job 3: Playwright E2E æµ‹è¯•
  # ============================================
  e2e:
    name: E2E æµ‹è¯•
    runs-on: ubuntu-latest
    needs: build
    defaults:
      run:
        working-directory: ./frontend

    steps:
      # 1. æ£€å‡ºä»£ç 
      - name: ğŸ“¥ Checkout ä»£ç 
        uses: actions/checkout@v4

      # 2. è®¾ç½® Node.js ç¯å¢ƒ
      - name: âš™ï¸ è®¾ç½® Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: './frontend/package-lock.json'

      # 3. å®‰è£…ä¾èµ–
      - name: ğŸ“¦ å®‰è£…ä¾èµ–
        run: npm ci

      # 4. å®‰è£… Playwright æµè§ˆå™¨
      - name: ğŸ­ å®‰è£… Playwright
        run: npx playwright install --with-deps

      # 5. ä¸‹è½½æ„å»ºäº§ç‰©
      - name: ğŸ“¥ ä¸‹è½½æ„å»ºäº§ç‰©
        uses: actions/download-artifact@v4
        with:
          name: dist
          path: frontend/dist

      # 6. å¯åŠ¨é¢„è§ˆæœåŠ¡å™¨
      - name: ğŸš€ å¯åŠ¨é¢„è§ˆæœåŠ¡å™¨
        run: |
          npm run preview &
          npx wait-on http://localhost:4173 -t 60000

      # 7. è¿è¡Œ Playwright æµ‹è¯•
      - name: ğŸ§ª è¿è¡Œ E2E æµ‹è¯•
        run: npx playwright test
        env:
          BASE_URL: http://localhost:4173

      # 7. ä¸Šä¼ æµ‹è¯•æŠ¥å‘Š
      - name: ğŸ“Š ä¸Šä¼ æµ‹è¯•æŠ¥å‘Š
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: frontend/playwright-report
          retention-days: 7

  # ============================================
  # Job 4: æ£€æŸ¥ç»“æœæ±‡æ€»
  # ============================================
  check-summary:
    name: âœ… æ£€æŸ¥ç»“æœæ±‡æ€»
    runs-on: ubuntu-latest
    needs: [code-quality, build, e2e]
    if: always()

    steps:
      - name: ğŸ“‹ æ£€æŸ¥ç»“æœ
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "Pure Stage CI æ£€æŸ¥ç»“æœæ±‡æ€»"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "âœ… ä»£ç è´¨é‡æ£€æŸ¥: ${{ needs.code-quality.result }}"
          echo "âœ… æ„å»ºæµ‹è¯•: ${{ needs.build.result }}"
          echo "âœ… E2E æµ‹è¯•: ${{ needs.e2e.result }}"
          echo ""

          if [[ "${{ needs.code-quality.result }}" == "success" ]] && \
             [[ "${{ needs.build.result }}" == "success" ]] && \
             [[ "${{ needs.e2e.result }}" == "success" ]]; then
            echo "ğŸ‰ æ‰€æœ‰æ£€æŸ¥é€šè¿‡ï¼ä»£ç ç¬¦åˆçº¯æ–°é˜¶æ®µæ ‡å‡†ã€‚"
            exit 0
          else
            echo "âŒ æ£€æŸ¥å¤±è´¥ï¼è¯·ä¿®å¤ä¸Šè¿°é—®é¢˜åé‡æ–°æäº¤ã€‚"
            exit 1
          fi
