# 新体系重构第三次交流记录

**会话时间**: 2025-11-26
**分支**: codex/eval-update
**状态**: 重构完成，待解决图片路径问题

---

## 📊 本次会话总结

### ✅ 已完成工作

#### 阶段1：类型系统改造（上次完成）
- types/index.ts: 添加 Zod Schema 和类型守卫
- utils/stageMap.ts: 引入 StageMeta 单一数据源
- utils/slug.ts: 统一使用 stageMap 函数

#### 阶段2：数据层改造（本次完成）

**2.1 重构 courseStore.ts**
- ✅ 删除 `mapOldStageToNew` 导入
- ✅ 删除 `migrateMockCourses()` 函数（约47行代码）
- ✅ 更新 state 初始化：`courses: mockCourses`（直接使用）
- 📉 代码从 298 行减少到 240 行

**2.2 更新 Mock 数据**
- ✅ 所有课程 stage 字段更新为新三级体系
- ✅ 手动生成符合规范的 slug
- ✅ 明确类型标注：`const mockCourses: Course[]`

**映射关系**:
- `free` → `basic` (免费体验课程 → 入门基础)
- `basic` → `basic` (已是新体系，保持不变)
- `advanced` → `intermediate` (旧的高级 → 新的进阶实战)

#### 阶段3：组件层改造（本次完成）

**3.1 更新 CampSection.vue**
- ✅ 更新注释中的 stageInfo 数据结构
- ✅ 删除旧体系的 5 个阶段（free/basic/advanced/project/landing）
- ✅ 替换为新三级体系（basic/intermediate/advanced）

**3.2 更新 PersonalDashboard.vue**
- ✅ 更新推荐课程数据的 stage 字段
- ✅ 添加注释说明新体系映射逻辑

**3.3 全局代码扫描**
- ✅ 使用 Grep 搜索旧 stage 值引用
- ✅ 使用 Grep 搜索遗留函数引用
- ✅ **结果**：无任何遗留引用

#### 阶段4：验证测试（本次完成）

**4.1 TypeScript 类型检查**
- ✅ 运行 `npm run type-check`
- ✅ **结果**：无类型错误，编译通过

**4.2 开发服务器测试**
- ⚠️ 启动服务器成功（http://localhost:5175）
- ❌ 发现图片路径错误（见下方问题）

---

## 📁 修改的文件

### 1. frontend/src/store/courseStore.ts
**变更**: 删除迁移逻辑，直接使用新体系数据
- 删除 `mapOldStageToNew` 导入
- 删除 `migrateMockCourses()` 函数
- 更新 12 个 Mock 课程的 stage 和 slug
- 代码减少：298行 → 240行（-58行，-19.5%）

### 2. frontend/src/components/CampSection.vue
**变更**: 更新注释中的阶段信息
- 更新 stageInfo 数据结构（注释代码）
- 删除旧的 5 个阶段定义
- 添加新的 3 个阶段定义

### 3. frontend/src/components/personCenter/PersonalDashboard.vue
**变更**: 更新推荐课程数据
- 更新 4 个推荐课程的 stage 字段
- 添加注释说明映射逻辑

---

## 🎯 架构决策

### 1. 数据迁移策略
**决策**: 删除运行时迁移，直接使用新体系数据
**原因**:
- 避免每次加载时执行迁移逻辑
- 减少运行时开销和控制台日志
- 数据源更清晰，便于维护

### 2. Mock 数据更新
**决策**: 手动更新 stage 和 slug 字段
**原因**:
- 确保数据准确性
- 便于代码审查
- 避免自动化脚本的潜在错误

### 3. 旧代码清理
**决策**: 彻底删除旧体系相关代码
**原因**:
- 减少代码复杂度
- 避免未来误用旧逻辑
- 提升代码可维护性

---

## ⚠️ 发现的问题

### 问题1: 图片路径错误

**错误信息**:
```
Failed to resolve import "@/assets/images/courses/free-unreal-cover-480.webp"
from "src/store/courseStore.ts". Does the file exist?
```

**根本原因**:
- courseStore.ts 中引用的图片路径不存在
- 实际图片位于不同的目录结构

**影响**:
- 开发服务器无法加载页面
- 课程卡片无法显示封面图

**需要行动**:
1. 查找实际的图片文件位置
2. 更新 courseStore.ts 中的图片导入路径
3. 或者将图片移动到正确的位置

---

## 📊 代码统计

### 删除代码量
- courseStore.ts: -58 行
- 总计: -58 行核心业务代码

### 修改代码量
- courseStore.ts: 12 个课程数据更新
- CampSection.vue: 注释区更新
- PersonalDashboard.vue: 4 个课程数据更新

### 质量指标
- TypeScript 编译: ✅ 通过
- 代码扫描: ✅ 无遗留引用
- 开发服务器: ⚠️ 图片路径问题

---

## 🔄 待完成工作

### 高优先级
1. **修复图片路径问题**
   - 查找正确的图片文件位置
   - 更新 courseStore.ts 的图片导入
   - 验证所有图片路径正确

2. **完成开发服务器测试**
   - 启动服务器并验证页面加载
   - 检查课程卡片显示
   - 测试阶段切换功能

### 中优先级
3. **Playwright 自动化验证**
   - 测试首页课程展示
   - 测试阶段切换功能
   - 截图对比验证

4. **创建遗留代码扫描脚本**
   - 编写自动化扫描脚本
   - 检测旧 stage 值引用
   - 检测旧函数引用

### 低优先级
5. **Git 提交**
   - 创建描述性的 commit message
   - 推送到远程分支
   - 准备 Pull Request

---

## 💡 下次会话建议

### 立即行动
1. **优先解决图片路径问题**
   - 使用 `find` 命令定位实际图片位置
   - 确认图片命名规范是否一致
   - 批量更新导入路径

### 测试验证
2. **完整的端到端测试**
   - 首页加载和渲染
   - 课程卡片显示
   - 阶段切换功能
   - 筛选和搜索功能

### 文档完善
3. **更新项目文档**
   - 记录新三级体系的使用方式
   - 更新开发指南
   - 添加迁移说明

---

## 📝 技术要点

### 新三级体系
- **basic**: 入门基础（免费 + 付费入门课程）
- **intermediate**: 进阶实战（会员可看或单独购买）
- **advanced**: 高阶训练（单买 + 会员9折）

### 类型安全
- 使用 `StageKey` 类型确保类型安全
- 使用 `assertStageKey()` 进行运行时校验
- 使用 `isStageKey()` 进行类型守卫

### 数据流
```
mockCourses (新体系数据)
    ↓
courseStore.state.courses
    ↓
组件 computed: filteredCourses
    ↓
CourseCard 渲染
```

---

## 🔗 相关资源

### PRD 文档
- `00 老的体系与新的体系.md`: 旧新体系对比
- `03-2新旧体系转换更详细的PRD.md`: 详细转换说明
- `x02新体系重构第二次交流记录.md`: 上次会话记录

### 核心文件
- `frontend/src/types/index.ts`: 类型定义
- `frontend/src/utils/stageMap.ts`: 阶段映射
- `frontend/src/store/courseStore.ts`: 课程数据

---

## ⚙️ 环境信息

- **Node.js**: 当前版本
- **Vite**: v7.0.0
- **开发服务器**: http://localhost:5175
- **Git 分支**: codex/eval-update
- **待推送提交**: 2 个本地提交

---

## 🎓 经验总结

### 成功实践
1. **渐进式重构**: 分阶段完成，便于回滚
2. **类型安全优先**: TypeScript 检查确保代码质量
3. **自动化扫描**: Grep 工具快速定位遗留代码
4. **测试驱动**: 每个阶段完成后立即验证

### 改进建议
1. **图片资源管理**: 建立更清晰的图片命名和组织规范
2. **Mock 数据维护**: 考虑使用专门的数据文件而非内联
3. **自动化脚本**: 开发更多自动化工具辅助重构

---

**会话状态**: 重构完成 90%，待解决图片路径问题后即可提交

**下次启动命令**:
```bash
# 1. 查找图片文件
find . -name "*cover*.webp" -o -name "*cover*.png"

# 2. 更新 courseStore.ts 的图片导入路径

# 3. 启动开发服务器测试
npm run dev
```
