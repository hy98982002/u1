# Doviai 前端「纯新阶段」架构落地指南

> **版本**：v1.0 · 2025‑11‑26  
> **适用分支**：`frontend/main`（纯新阶段切换后）  
> **作者**：ChatGPT (sync w/ Claude Code)

---

## 1. 背景与目标

| 目标               | 说明                                                                                                               |
| ------------------ | ------------------------------------------------------------------------------------------------------------------ |
| 移除 legacy 迁移层 | 彻底删除 `LEGACY_STAGE_MAP` / `mapOldStageToNew` 与统计逻辑，只保留 _basic / intermediate / advanced_ 三枚举。     |
| 类型 & 运行时安全  | 通过 **静态 TS 类型** + **zod 运行时校验** 双重保证：任何非法 `stage` 在 _开发 / 构建 / 运行_ 三阶段均 fail‑fast。 |
| 单一来源原则 (SSR) | 所有标签、slug、样式均从 `StageMeta` 常量派生，组件禁止硬编码。                                                    |
| SEO / AEO 完整性   | 图片文件、slug、JSON‑LD、LRMI 规范一次性更新，保持“三引擎同步”兼容。                                               |
| DevOps 可观测      | CI + e2e + schema 测试多层阻断遗留值；提供灰度 & 回滚方案。                                                        |

---

## 2. 目录级影响矩阵

| 文件/目录                          | 动作         | 关键点                                                                                          |
| ---------------------------------- | ------------ | ----------------------------------------------------------------------------------------------- |
| `src/types/index.ts`               | **修改**     | `StageKey` 改为 3 枚举；暴露 `StageKeySchema`、`isStageKey()`、`assertStageKey()`（基于 zod）。 |
| `src/utils/stageMap.ts`            | **重写**     | 引入 `StageMeta` 常量；输出 `getStageLabel/Slug/Style()`；内部不再尝试修复旧值，只抛错。        |
| `src/utils/slug.ts`                | **精简**     | 仅处理新 slug；保留 `buildCourseSlug(name, stage)`、`parseSlug()`。                             |
| `src/store/courseStore.ts`         | **删除迁移** | `loadMockData()` 中调用 `assertStageKey()`，无旧值 fallback。                                   |
| `src/components/**/*`              | **改造**     | 所有使用 `stage` 的 props 改为 `StageKey`；示例见 § 5。                                         |
| `src/utils/jsonld/*.ts`            | **改造**     | 构建前执行 `StageKeySchema.parse(stage)`；新增会员 9  折 `offers` 字段。                        |
| `assets/images/courses/`           | **重命名**   | 统一 `courseName(-membership)-{stage}.webp`。                                                   |
| `.github/workflows/pure-stage.yml` | **新增**     | CI 阶段：lint → type‑check → legacy‑grep → schema‑test → playwright。                           |

---

## 3. 类型与 Schema 定义

```ts
// src/types/index.ts
import { z } from 'zod'

export const StageKeySchema = z.enum(['basic', 'intermediate', 'advanced'])
export type StageKey = z.infer<typeof StageKeySchema>

export const isStageKey = (v: string): v is StageKey => StageKeySchema.safeParse(v).success
export const assertStageKey = (v: string): asserts v is StageKey => StageKeySchema.parse(v)
```

### 3.1 `StageMeta` 单一来源

```ts
// src/utils/stageMap.ts
import type { StageKey } from '@/types'

export const StageMeta = {
  basic: { label: '入门', style: 'badge-basic', slug: 'beginner' },
  intermediate: { label: '进阶', style: 'badge-mid', slug: 'intermediate' },
  advanced: { label: '高阶', style: 'badge-adv', slug: 'advanced' }
} as const

export const getStageLabel = (key: StageKey) => StageMeta[key].label
export const getStageSlug = (key: StageKey) => StageMeta[key].slug
export const getStageStyle = (key: StageKey) => StageMeta[key].style
```

_以上常量将被 **tree‑shaking** 完整优化，无循环依赖。_

---

## 4. 数据层改造

1. **Mock 数据**：在 JSON 生成脚本中加入
   ```js
   if (!StageKeySchema.safeParse(item.stage).success)
     throw new Error(`非法 stage: ${item.stage} (${item.id})`)
   ```
2. **Store 注入**：
   ```ts
   courses.forEach(c => assertStageKey(c.stage))
   state.courses = courses
   ```
3. **Slug 生成**：
   ```ts
   export const buildCourseSlug = (courseName: string, stage: StageKey) =>
     `${slugify(courseName)}-${getStageSlug(stage)}`
   ```

---

## 5. 组件消费示例

```vue
<!-- StageTabs.vue -->
<script setup lang="ts">
import { StageMeta, StageKey } from '@/utils/stageMap'

const STAGES: StageKey[] = ['basic', 'intermediate', 'advanced']
</script>
<template>
  <ul class="flex gap-4">
    <li v-for="s in STAGES" :key="s">
      <button :class="StageMeta[s].style">{{ StageMeta[s].label }}</button>
    </li>
  </ul>
</template>
```

_组件端完全不再接触旧值，也不写任何映射逻辑。_

---

## 6. JSON‑LD 构建强化

```ts
// buildCourseJsonLd.ts
import { StageKeySchema } from '@/types'

export const buildCourse = (course: Course) => {
  StageKeySchema.parse(course.stage) // 运行时校验
  return {
    '@context': 'https://schema.org',
    '@type': 'Course',
    // ...省略...
    offers: {
      '@type': 'Offer',
      price: course.price,
      priceCurrency: 'CNY',
      // 会员 9 折
      discount: course.membershipExclusive ? 0.9 : undefined
    }
  }
}
```

同时在 CI 使用 **schema-dts CLI**：

```shell
npx schema-dts-validate dist/**/*.jsonld
```

---

## 7. CI / QA Pipeline (`.github/workflows/pure-stage.yml`)

```yaml
name: Pure Stage CI
on:
  pull_request:
    paths:
      - 'src/**'
      - 'assets/images/**'

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v2
        with: { version: 8 }
      - run: pnpm install --frozen-lockfile
      - run: pnpm run lint && pnpm run type-check
      - name: Legacy grep
        run: |
          if grep -R --exclude-dir=node_modules -E "(free|project|landing|high)" src/; then
            echo '❌ 发现旧阶段字符串'; exit 1; fi
      - name: Structured‑data test
        run: npx schema-dts-validate dist/**/*.jsonld
      - name: Playwright
        uses: microsoft/playwright-github-action@v1
```

---

## 8. 灰度与回滚策略

| 时机       | 操作                                                               | 监控点                 |
| ---------- | ------------------------------------------------------------------ | ---------------------- |
| **T‑7 天** | 打开 `PURE_STAGE_WARN_ONLY=true` 环境变量 → 记录旧值警告，不阻断。 | Sentry 异常率 <5/min。 |
| **T0**     | 切换 `WARN_ONLY → THROW`；CI 强制通过。                            | 旧值触发率应为 0。     |
| **回滚**   | 环境变量回到 WARN，回退镜像，最长 30 min。                         | 比对 5xx 曲线。        |

---

## 9. 命名规范速查

| 维度 | 规则                                   | 示例                                       |
| ---- | -------------------------------------- | ------------------------------------------ |
| 图片 | `courseName(-membership)-{stage}.webp` | `illustrator-membership-intermediate.webp` |
| Slug | `course-name-{stage}`                  | `/course/ai-logo-design-beginner`          |
| 类型 | 三选一                                 | basic / intermediate / advanced            |

---

## 10. ADR 记录（摘录）

```md
# ADR‑14: Adopt Pure Stage Architecture

_Status_: Accepted 2025‑11‑26

## Context

Legacy 枚举 (free/project/landing/high...) 与新 3 阶枚举并存，导致... <略>

## Decision

统一采用 basic/intermediate/advanced；入口强校验；删除迁移映射。

## Consequences

- 代码简化 430 行；运行时错误前移。

* 部署窗口需灰度。
```

---

## 11. 附录

### 11.1 遗留扫描脚本 (`tools/scan‑legacy.js`)

```js
import { globby } from 'globby'
import fs from 'fs/promises'

const PATTERN = /(free|project|landing|high)/
const files = await globby(['src/**/*.{ts,vue,js,jsx,tsx}'])
let hasOld = false
for (const f of files) {
  const txt = await fs.readFile(f, 'utf8')
  if (PATTERN.test(txt)) {
    console.error('❌', f)
    hasOld = true
  }
}
if (hasOld) process.exit(1)
```

### 11.2 Playwright 样例

```ts
test('course pages render', async ({ page }) => {
  for (const stage of ['basic', 'intermediate', 'advanced']) {
    await page.goto(`/course/ai-logo-design-${stage}`)
    await expect(page.locator('script[type="application/ld+json"]').nth(0)).toContainText(stage)
  }
})
```

---

### ✅ 交付方式

- 保存在本仓根目录 `docs/Pure-Stage-Guide.md`，供 **Claude Code** 引用。
- 合并时，请确保 CI 通过；否则阻断。

## 12. 接口示例

### 12.1 后端 REST 示例

```http
GET /api/courses?stage=basic
200 OK
Content-Type: application/json

[
  {
    "id": "123",
    "name": "AI Logo Design",
    "stage": "basic",
    "slug": "ai-logo-design-beginner",
    "price": 199,
    "membershipExclusive": false
  }
]
```

### 12.2 TypeScript DTO

```ts
export interface CourseDTO {
  id: string
  name: string
  stage: StageKey // basic | intermediate | advanced
  slug: string
  price: number
  membershipExclusive: boolean
}

export interface CourseListResponse extends Array<CourseDTO> {}
```

### 12.3 Store 方法调用

```ts
import { api } from '@/utils/api'
import { assertStageKey } from '@/types'

export async function fetchCoursesByStage(stage: StageKey) {
  assertStageKey(stage)
  const res = await api.get<CourseListResponse>(`/courses`, { params: { stage } })
  return res.data
}
```

### 12.4 GraphQL 查询示例

```graphql
query Courses($stage: StageKey!) {
  courses(stage: $stage) {
    id
    name
    slug
    stage
    price
    membershipExclusive
  }
}
```

### 12.5 JSON-LD 构建调用

```ts
import { buildCourse } from '@/utils/jsonld'

const courseLd = buildCourse(course)
document.head.appendChild(
  Object.assign(document.createElement('script'), {
    type: 'application/ld+json',
    text: JSON.stringify(courseLd)
  })
)
```

---

# ⬇️ Appendix B — **Legacy Safeguard Hardening PRD** (2025‑11‑27)

> 本附录在《Pure Stage Architecture Guide》基础上，彻底移除 _legacy_ 兜底与隐式降级，强化“入口即校验、运行时可观测”。可直接交由 **Claude Code** 执行。

## B‑0  背景

- 1126  重构后仍残留：
  1. `mapOldStageToNew()` + fallback → `basic`。
  2. store / getter 使用 `string` 参数，无断言。
  3. JSON‑LD 构建工具缺位。
- 以上会在 **外部数据脏值** 时静默失败，违背“Fail‑Fast”策略。

## B‑1  目标

| #   | 目标                       | KPI                                                  |
| --- | -------------------------- | ---------------------------------------------------- |
| 1   | 移除全部 _Legacy Map_ 代码 | repo 搜索 `mapOldStageToNew` = 0                     |
| 2   | 数据入口 100% 运行时断言   | 本地 & CI 执行时无 `StageKeySchema.parse` 未捕获报错 |
| 3   | JSON‑LD 工具链完善         | `schema-dts-validate` 通过，Sentry 抓取  0 error     |

## B‑2  范围

- **必须做**：stageMap 重写、store / getter 参数收紧、JSON‑LD builder 实现、CI grep 规则更新。
- **不做**：后端 API 改造（后端仅需配合输出新枚举）；图片再重命名（已完成）。

## B‑3  实施步骤

1. **删除 legacy 文件**  
   `rm src/utils/stageMap.legacy.ts`；在新版中禁止出现 `mapOldStageToNew`。
2. **stageMap.ts 重写**  
   *只*  输出 `StageMeta` + `getStageX` + `slugToStageKey`。
3. **类型断言下沉**
   - `courseStore`：getter `getCoursesByStage(stage: StageKey)` + `assertStageKey(stage)` 调用。
   - 组件 props `stage?: StageKey`。
4. **JSON‑LD Builder**  
   `utils/jsonld/buildCourseJsonLd.ts` & `buildProgramJsonLd.ts`，函数首行 `assertStageKey(course.stage)`。
5. **CI  更新**
   - 新增 grep：`grep -R "mapOldStageToNew" src/`
   - 新增 Playwright 测试 JSON‑LD script 存在且含合法阶段。
6. **监控**  
   Sentry tag `stage_mismatch`; 生产首周保持 `WARN_ONLY`。

## B‑4  验收标准

| 测试                                      | 预期                         |
| ----------------------------------------- | ---------------------------- |
| `npm run type-check`                      | 0 error / 0 warning          |
| `pnpm run legacy-grep`                    | 输出为空                     |
| Playwright e2e (`stage_mismatch.spec.ts`) | 跑通 3  阶段 URL，无断言失败 |
| Sentry prod 24h 观测                      | `stage_mismatch` < 1 / hour  |

## B‑5  回滚方案

- 环境变量 `PURE_STAGE_WARN_ONLY=true` 关闭 throw。
- GitHub Actions `gh deploy rollback --env=prod --rev=<prev_sha>`；触发 CDN cache purge。

---

# ⬇️ Appendix C — **技术落地任务清单**

| PRI | 任务                                                   | Owner        | 估时  |
| --- | ------------------------------------------------------ | ------------ | ----- |
| P0  | 删除  `mapOldStageToNew`  及其引用                     | FE Team      | 1 h   |
| P0  | store / getter 参数改 `StageKey` + assert              | FE Team      | 1 h   |
| P0  | 新建  `buildCourseJsonLd.ts` & `buildProgramJsonLd.ts` | SEO Sub‑team | 2 h   |
| P1  | 重写  `stageMap.ts` (StageMeta)                        | FE Team      | 0.5 h |
| P1  | CI grep & Playwright 用例                              | DevOps       | 1 h   |
| P2  | Sentry tag & WARN_ONLY flag                            | DevOps       | 0.5 h |

> **交付物**：单一 PR，包含代码、CI 变动、Playwright 用例、ADR #15《Legacy Safeguard Removal》。

---

# ⬇️ Appendix D — **示例代码片段**

### D‑1 stageMap.ts

```ts
export const StageMeta = {
  basic: { label: '入门', style: 'badge-basic', slug: 'basic' },
  intermediate: { label: '进阶', style: 'badge-mid', slug: 'intermediate' },
  advanced: { label: '高阶', style: 'badge-adv', slug: 'advanced' }
} as const

export type StageKey = keyof typeof StageMeta
export const assertStageKey = (v: string): asserts v is StageKey => {
  if (!(v in StageMeta)) throw new Error(`[stage] 非法值: ${v}`)
}
```

### D‑2 courseStore.ts (节选)

```ts
getCoursesByStage: state => (stage: StageKey) => {
  assertStageKey(stage)
  return state.courses.filter(c => c.stage === stage)
}
```

### D‑3 buildCourseJsonLd.ts

```ts
export const buildCourseJsonLd = (c: CourseDTO) => {
  assertStageKey(c.stage)
  return {
    '@context': 'https://schema.org',
    '@type': 'Course',
    name: c.name,
    educationalLevel: c.stage,
    image: c.cover,
    offers: { '@type': 'Offer', price: c.price, priceCurrency: 'CNY' }
  }
}
```

---

> **完成后**，推送 `feature/pure-stage-hardening` 分支，触发 CI；一旦通过即可合并并全量发布。
