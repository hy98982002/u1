### PRD - **“Program JSON-LD & CI 闭环” 增量迭代**

| **版本**       | 2025-11-26 (draft)                             |
| -------------- | ---------------------------------------------- |
| **目标里程碑** | _codex/eval-update_ 分支 - 最后一轮 P0+P1 收口 |
| **责任方**     | FE (你 + ClaudeCode)                           |
| **审阅人**     | SEO Owner / QA-Automation                      |

---

#### 1 · 背景

04-1/04-2 系列的核心安全与质量门禁已全部落地，但评测报告仍标出 **两处残缺**：

1. ProgramA/B 页面尚未注入 **Program JSON-LD**，搜索引擎看不到课程体系语义。
2. CI 的 _e2e_ Job 被 `if: false` 屏蔽，导致 Schema/视觉回归测试无法在 PR 阶段自动执行。

---

#### 2 · 范围

| 优先级 | 任务                                                                                                                    | 产出文件                                                                  |
| ------ | ----------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------- |
| **P0** | **2-a** 在 ProgramAView.vue / ProgramBView.vue 注入 `buildProgramJsonLd()` 并输出 `<script type="application/ld+json">` | `src/views/program/ProgramAView.vue` `src/views/program/ProgramBView.vue` |
|        | **2-b** 收紧 `courseStore.getCoursesByStage` 入参 & 运行时断言                                                          | `src/store/courseStore.ts`                                                |
| **P1** | **2-c** 启用 e2e Job：移除 `if: false` 并补 `uses: microsoft/playwright-action@v1`                                      | `.github/workflows/pure-stage.yml`                                        |
|        | **2-d** 在新 CI 阶段执行 `npm run test:e2e`（现有脚本已就绪）                                                           | 同上                                                                      |

_(P2: Sentry 监控、缓存层、国际化等仍保持可选，后续排期)_

---

#### 3 · 非范围

- 课程详情页 JSON-LD 已完备 —— 不再改动。
- 不新增阶段枚举；图片命名规范已符合“课程名-阶段”。

---

#### 4 · 验收标准

1. **ProgramA/B 源码**：首行 `import { buildProgramJsonLd } from '@/utils/jsonld'`，模板第一个节点输出 JSON-LD，运行时经 `assertStageKey` 校验。
2. **CI**：PR → GitHub Actions 必须串行跑 **type-check → legacy-scan → build → e2e** 四步；Playwright 用例全绿。
3. **courseStore**：给错误拼写如 `'basci'` 时立即抛错；不再静默返回空数组。
4. `npm run type-check && npm run build && npm run test:e2e` **= 0 error**。

---

#### 5 · 时间线

| 日程 | 负责人     | 备注                            |
| ---- | ---------- | ------------------------------- |
| D0   | ClaudeCode | 完成代码差异（见下节 Diff）     |
| D0   | 你         | Code Review + merge             |
| D0+1 | QA-bot     | 验证线上 Program JSON-LD 生效   |
| D0+3 | SEO Owner  | Search Console 检查 Rich Result |

---

#### 6 · 风险与缓解

| 风险                                 | 缓解                                                                                          |
| ------------------------------------ | --------------------------------------------------------------------------------------------- |
| JSON-LD 语法误拼，导致结构化数据报错 | 单元 + Playwright “expect(page.locator('script[type="application/ld+json"]').toHaveCount(1))” |
| e2e Job 打断 CI                      | 首次运行用 `continue-on-error: false` 并在分支上测试，通过后合并                              |

---

### 技术 Diff（逐文件）

> _摘录仅示关键行，完整补丁由 Git 生成。_

---

#### 1 · `src/store/courseStore.ts`

```diff
- getCoursesByStage: state => (stage: string) =>
-   state.courses.filter(c => c.stage === stage),
+ getCoursesByStage: state => (stage: StageKey) => {
+   assertStageKey(stage)               // Fail-Fast 防御
+   return state.courses.filter(c => c.stage === stage)
+ },
```

---

#### 2 · `src/views/program/ProgramAView.vue` _(ProgramB 同理)_

```diff
<script setup lang="ts">
-import { onMounted } from 'vue'
+import { onMounted, computed } from 'vue'
+import { buildProgramJsonLd } from '@/utils/jsonld'
+import { assertStageKey } from '@/utils/stageMap'
+import { useCourseStore } from '@/store/courseStore'

-// ...原逻辑
+const store = useCourseStore()
+// ① 仅列出合法阶段课程
+const programCourses = computed(() => {
+  return store.courses.filter(c => {
+    assertStageKey(c.stage)
+    return c.stage === 'intermediate' // <- 按需调整
+  })
+})
+
+// ② 生成 JSON-LD
+const jsonLd = computed(() => buildProgramJsonLd({
+  name: 'Program A · 会员实战训练体系',
+  courses: programCourses.value
+}))
</script>

<template>
+  <!-- SEO / AEO -->
+  <component :is="'script'"
+             type="application/ld+json"
+             v-if="jsonLd"
+             v-html="jsonLd" />
   <!-- 其余 UI 不变 -->
 </template>
```

_(原文件仅 80 行，无任何 JSON-LD 输出，见评测) _

---

#### 3 · `.github/workflows/pure-stage.yml`

```diff
-  e2e:
-    if: false
-    needs: build
-    runs-on: ubuntu-latest
-    steps:
-      - name: Run Playwright tests
-        run: npm run test:e2e
+  e2e:
+    needs: build
+    runs-on: ubuntu-latest
+    steps:
+      - uses: actions/checkout@v4
+      - uses: actions/setup-node@v4
+        with:
+          node-version: 22
+      - run: npm ci
+      - name: Install browsers
+        run: npx playwright install --with-deps
+      - name: Run Playwright tests
+        run: npm run test:e2e
```

_(原文件 178 行处禁用了 Job) _

---

#### 4 · 新增／编辑 Playwright 用例 _(若已存在仅补断言)_

```ts
test('Program A page exposes JSON-LD', async ({ page }) => {
  await page.goto('/program-a')
  // 确认只有一段 JSON-LD 且包含 EducationalProgram 类型
  const script = page.locator('script[type="application/ld+json"]')
  await expect(script).toHaveCount(1)
  await expect(script).toContainText('"@type":"EducationalOccupationalProgram"')
})
```

---

### FAQ - _是否仅做 P0/P1？_

是的。05-1 评测已确认 **P0+P1 = 100 %** 功能闭环仅剩上表 4 项差距，其余 P2 监控/缓存可后置。

---

> **下一步**
>
> 1. 把本 PRD+Diff 交给 ClaudeCode。
> 2. 合并后观察 Search Console “结构化数据” → _Program_ 新增记录。
