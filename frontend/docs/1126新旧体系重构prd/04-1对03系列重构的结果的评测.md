### 结论：**1126 重构评测里的两条改进建议仍需落实**

昨日已把图片路径、课程数据切到新三级枚举，但代码里仍残留“**隐式降级**”与“**校验缺口**”。如果不再收敛，这些隐患会在以后接入真实后端或第三方数据时被悄悄放大，反而增加维护成本。

---

## 1 当前缺口与风险

| 模块                 | 发现的问题                                                                                           | 影响                                           | 证据 |
| -------------------- | ---------------------------------------------------------------------------------------------------- | ---------------------------------------------- | ---- |
| **courseStore**      | `getCoursesByStage(stage: string)` 仍收 string，无任何断言；一旦外部调用传入拼写错误会静默返回空数组 | 隐蔽数据错漏，难排查                           |      |
| **stageMap（旧版）** | 仍保留 `mapOldStageToNew` + _fallback_ → `basic`，等同“吃掉”非法值                                   | 与 PRD 的 _fail-fast_ 思路相悖，掩盖后端脏数据 |      |
| **JSON-LD 构建工具** | `src/utils/jsonld/` 目录缺失，Program 页面暂未做阶段校验                                             | 结构化数据不完整，AEO／富结果效果受限          |      |

---

## 2 采纳建议后的最小改动方案

> **目标**：完全移除 _legacy path_，入口即报错；让非法 `stage` 在开发期就暴露，而不是在线上产生无声错误。

### 2.1 删除旧映射文件

```diff
- src/utils/stageMap.ts     // legacy 版（含 mapOldStageToNew 等）
+ // 保留新版 StageMeta 版本，且仅导出 getStageLabel / getStageSlug / slugToStageKey / getStageStyle
```

### 2.2 在数据层加 **assertStageKey**

```ts
// courseStore.ts
import { assertStageKey } from '@/types'

export const useCourseStore = defineStore('course', {
  state: () => ({
    courses: mockCourses.map(c => {
      assertStageKey(c.stage)          // 运行时校验
      return c
    }),
    currentStage: 'basic' as StageKey,
    ...
  }),
  getters: {
-   getCoursesByStage: state => (stage: string) =>
-     state.courses.filter(c => c.stage === stage),
+   getCoursesByStage: state => (stage: StageKey) => {
+     assertStageKey(stage)
+     return state.courses.filter(c => c.stage === stage)
+   },
    ...
  }
})
```

### 2.3 完成 **JSON-LD 工具**（示例）

```ts
// utils/jsonld/buildCourseJsonLd.ts
import { assertStageKey } from '@/types'
export const buildCourseJsonLd = (course: Course) => {
  assertStageKey(course.stage)
  return {
    '@context': 'https://schema.org',
    '@type': 'Course',
    name: course.title,
    educationalLevel: course.stage,
    image: course.cover,
    ...
  }
}
```

并在 `Program*.vue` 调用前统一 `assertStageKey`，确保输出前无残留旧值。

---

## 3 如何降低上线风险

| 风险                          | 缓解措施                                                                                               |
| ----------------------------- | ------------------------------------------------------------------------------------------------------ |
| 切掉旧映射后端仍偶尔返回旧值  | **日志 + Sentry**：`assertStageKey` 抛错同时上报 payload，便于回溯；开发、预发环境开启 _error overlay_ |
| 新增校验导致编译不通过        | 先跑 `--noEmit` 类型检查；再用数据脚本扫描 mock/静态 JSON，自动打印非法枚举                            |
| JSON-LD 新工具与 SEO 标记冲突 | 在 `robots.txt` 里先对预发域名放行，再用 `urlinspect` 验证富结果，再正式推主站                         |

---

## 4 代码审查清单（Checklist）

1. [ ] **唯一的 `stageMap`**：repo 中只剩新版 `StageMeta` 版本，找不到 `mapOldStageToNew / migrateCourseStages`。
2. [ ] **所有 getter / action 参数为 `StageKey`**，且入口 `assertStageKey`。
3. [ ] **无 `LEGACY_STAGE_MAP` 引用**。
4. [ ] **Program / JSON-LD** 调用统一的 `buildCourseJsonLd | buildProgramJsonLd`。
5. [ ] CI 增加 `grep -R '\b(free|beginner|hands-on|project|vip)\b.*-cover-' assets/images` 之类脚本，确保图片命名无回退。

---

### 结语

- **是的，应当采纳 1126 评测里的两条建议**。它们并非功能改动，而是**收尾期“防御性代码”**，能在数据源再变动时提供明确、可观测的失败信号。
- 变动范围聚焦在工具层与类型校验，可通过一次 MR 合并完成，属于“高收益、低风险”项。

落实后，就真正达到“**纯新阶段、入口即校验、长期零迁移成本**”的预期。
